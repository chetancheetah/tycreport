<html>
<head>
<style>
table {
  border-spacing: 0;
  width: 100%;
  border: 1px solid #ddd;
}

th, td {
  text-align: left;
  padding: 16px;
}

tr:nth-child(even) {
  background-color: #f2f2f2
}
</style>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
<script type="text/javascript">
AWS.config.update({
  region: "us-east-1",
  // The endpoint should point to the local or remote computer where DynamoDB (downloadable) is running.
  endpoint: 'http://localhost:8000',
//  endpoint: 'https://464429638625.signin.aws.amazon.com/console',
  /*
    accessKeyId and secretAccessKey defaults can be used while using the downloadable version of DynamoDB.
    For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  */
  accessKeyId: "AKIAWYIRJ4PQYN3OS2OI",
  secretAccessKey: "F1UYVIjDNRWqqO7kq+2OgItbFyEvOm5zNqxVzcmy"
});

  /*
     Uncomment the following code to configure Amazon Cognito and make sure to
     remove the endpoint, accessKeyId and secretAccessKey specified in the code above.
     Make sure Cognito is available in the DynamoDB web service region (specified above).
     Finally, modify the IdentityPoolId and the RoleArn with your own.
  */
/*
AWS.config.region = 'us-east-1'; // Region
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: "us-east-1:4f0994f9-700c-4c38-a93e-0c634934d483",
    RoleArn: "arn:aws:iam::464429638625:role/Cognito_tycscUnauth_Role"
});
*/

var dynamodb = new AWS.DynamoDB();
var docClient = new AWS.DynamoDB.DocumentClient();


function createTransactions() {
    var params = {
        TableName : "Transactions",
        KeySchema: [
            { AttributeName: "Bill Number", KeyType: "HASH"},
            { AttributeName: "Bill Date Time", KeyType: "RANGE"},
        ],
        AttributeDefinitions: [
            { AttributeName: "Bill Number", AttributeType: "S" },
            { AttributeName: "Bill Date Time", AttributeType: "S" },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5
        }
    };

    dynamodb.createTable(params, function(err, data) {
        if (err) {
            document.getElementById('textarea').innerHTML += "Unable to create table: " + "\n" + JSON.stringify(err, undefined, 2);
        } else {
            document.getElementById('textarea').innerHTML += "Created table: " + "\n" + JSON.stringify(data, undefined, 2);
        }
    });
}

function deleteTransactions() {
    var params = {
        TableName : "Transactions"
    };
    dynamodb.deleteTable(params, function(err, data) {
        if (err) {
            document.getElementById('textarea').innerHTML += "Unable to delete table: " + "\n" + JSON.stringify(err, undefined, 2);
        } else {
            document.getElementById('textarea').innerHTML += "Table deleted.";
        }
    });
}

function listTransactions() {
    var params = {
        TableName : "Transactions"
    };
    dynamodb.listTables(params, function(err, data) {
    if (err){
        document.getElementById('textarea').innerHTML += "Unable to list tables: " + "\n" + JSON.stringify(err, undefined, 2);
    }
    else{
     document.getElementById('textarea').innerHTML += "List of tables: " + "\n" + JSON.stringify(data, undefined, 2);
    }
});
}

function scanTransactions() {
    //document.getElementById('textarea').innerHTML = "";
    //document.getElementById('textarea').innerHTML += "Scanning for transactions between 1950 and 1975." + "\n";

    var params = {
        TableName: "Transactions",
//        ProjectionExpression: "#yr, Name",
        FilterExpression: "#yr between :start_yr and :end_yr",
        ExpressionAttributeNames: {
            "#yr": "year"
        },
        ExpressionAttributeValues: {
            ":start_yr": 1950,
            ":end_yr": 2019
        }
    };
    var html = ""
    docClient.scan(params, onScan);

    function onScan(err, data) {
        if (err) {
            document.getElementById('textarea').innerHTML += "Unable to scan the table: " + "\n" + JSON.stringify(err, undefined, 2);
        } else {
            // Print all the transactions
            //document.getElementById('textarea').innerHTML += "Scan succeeded: count = "+ data.Items.length + "\n";
            html += "<table border='1|1'><tr>";
            for (h in data.Items[0]) {
                html += "<th>"+h+"</th>";
            }
            data.Items.forEach(function(t) {
                html+="<tr>";
                for (h in data.Items[0]) {
                   html+="<td>"+t[h]+"</td>";
                }
                html+="</tr>";
            });
            html +="</table>";
        }
        document.getElementById('textarea').innerHTML += html
    }
}

function createShifts() {
    var params = {
        TableName : "Shifts",
        KeySchema: [
            { AttributeName: "Name", KeyType: "HASH"},
            { AttributeName: "Clock-In", KeyType: "RANGE"},
        ],
        AttributeDefinitions: [
            { AttributeName: "Name", AttributeType: "S" },
            { AttributeName: "Clock-In", AttributeType: "S" },
        ],
        ProvisionedThroughput: {
            ReadCapacityUnits: 5,
            WriteCapacityUnits: 5
        }
    };

    dynamodb.createTable(params, function(err, data) {
        if (err) {
            document.getElementById('textarea').innerHTML += "Unable to create table: " + "\n" + JSON.stringify(err, undefined, 2);
        } else {
            document.getElementById('textarea').innerHTML += "Created table: " + "\n" + JSON.stringify(data, undefined, 2);
        }
    });
}

function deleteShifts() {
    var params = {
        TableName : "Shifts"
    };
    dynamodb.deleteTable(params, function(err, data) {
        if (err) {
            document.getElementById('textarea').innerHTML += "Unable to delete table: " + "\n" + JSON.stringify(err, undefined, 2);
        } else {
            document.getElementById('textarea').innerHTML += "Table deleted.";
        }
    });
}

function listShifts() {
    var params = {
        TableName : "Shifts"
    };
    dynamodb.listTables(params, function(err, data) {
    if (err){
        document.getElementById('textarea').innerHTML += "Unable to list tables: " + "\n" + JSON.stringify(err, undefined, 2);
    }
    else{
     document.getElementById('textarea').innerHTML += "List of tables: " + "\n" + JSON.stringify(data, undefined, 2);
    }
});
}

function scanShifts() {

    var params = {
        TableName: "Shifts",
//        ProjectionExpression: "#yr, Name",
        FilterExpression: "#yr between :start_yr and :end_yr",
        ExpressionAttributeNames: {
            "#yr": "year"
        },
        ExpressionAttributeValues: {
            ":start_yr": 1950,
            ":end_yr": 2019
        }
    };
    var html = ""
    docClient.scan(params, onScan);

    function onScan(err, data) {
        if (err) {
            document.getElementById('textarea').innerHTML += "Unable to scan the table: " + "\n" + JSON.stringify(err, undefined, 2);
        } else {
            // Print all the shifts
            //document.getElementById('textarea').innerHTML += "Scan succeeded: count = "+ data.Items.length + "\n";
            html += "<table border='1|1'><tr>";
            for (h in data.Items[0]) {
                html += "<th>"+h+"</th>";
            }
            data.Items.forEach(function(t) {
                html+="<tr>";
                for (h in data.Items[0]) {
                   html+="<td>"+t[h]+"</td>";
                }
                html+="</tr>";
            });
            html +="</table>";
        }
        document.getElementById('textarea').innerHTML += html
    }
}

function createTables() {
    document.getElementById('textarea').innerHTML = ""
    createTransactions();
    createShifts();
}

function deleteTables() {
    document.getElementById('textarea').innerHTML = ""
    deleteTransactions();
    deleteShifts();
}

function listTables() {
    document.getElementById('textarea').innerHTML = ""
    listTransactions();
    listShifts();
}

function scanTables() {
    document.getElementById('textarea').innerHTML = ""
    scanTransactions();
    scanShifts();
}

function processFile(evt) {
    document.getElementById('textarea').innerHTML = "";
    document.getElementById('textarea').innerHTML += "Importing transactions and shifts into DynamoDB. Please wait..." + "\n";
    var file = evt.target.files[0];
    var txn_count = 0;
    var txns = {}
    if (file) {
        var r = new FileReader();
        r.onload = function(e) {
            var contents = e.target.result;
            var allRows = contents.split('\n');
            allRows.forEach(function (row) {
                row = row.replace("\r", "");
                // handle amount greater than 1000
                if (row.search("\"\\$")>0) {
//"
                   var nrow = "";
                   var amount = 0;
                   for (var i = 0; i < row.length; i++) {
                      var c = row.charAt(i);
                      if (c == '$')
                          amount = 1;
                      if (c == '.')
                          amount = 0;
                      if (c == ',' && amount)
                          continue;
                      nrow += c;
                    }
                    row = nrow
                }
                var cols = row.split(',');
                if (cols.length == 13 && cols[0] != "Name") {
                    var year = parseInt(cols[9].split('-')[0]);
                    var now = new Date(cols[9].split(' ')[0]);
                    var start = new Date(year, 0, 0);
                    var diff =  now - start + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);;
                    var day = Math.floor(diff / (1000*60*60*24));
                    var key = cols[10] + cols[9];
                    if (!(key in txns)) {
                        txns[key] = 0;
                    }
                    txns[key] += 1;
                    var params = {
                        TableName: "Transactions",
                        Item: {
                            "year": year,
                            "day" : day,
                            "Name": cols[0],
                            "Applied to Bill": Number(cols[1].replace(/[^0-9.-]+/g,"")),
                            "Tip": Number(cols[2].replace(/[^0-9.-]+/g,"")),
                            "Payment Amount": Number(cols[3].replace(/[^0-9.-]+/g,"")),
                            "CC Tip Out to House": Number(cols[4].replace(/[^0-9.-]+/g,"")),
                            "Change": Number(cols[5].replace(/[^0-9.-]+/g,"")),
                            "Type": cols[6],
                            "Subtotal with Tax": Number(cols[7].replace(/[^0-9.-]+/g,"")),
                            "Gratuity": Number(cols[8].replace(/[^0-9.-]+/g,"")),
                            "Bill Date": cols[9].split(' ')[0],
                            "Bill Date Time": cols[9],
                            "Bill Number": cols[10] + "_" + txns[key],
                            "Order Number": Number(cols[11]),
                            "Staff": cols[12],
                        }
                    };
                    docClient.put(params, function (err, data) {
                        if (err) {
                            console.log("Unable to add transaction: " + cols[11] + "\n");
                        } else {
                            ++txn_count;
                            document.getElementById('textarea').innerHTML += "Added:  Bill Number" + cols[10] + " Bill Date Time " +cols[9] + " count "+ txn_count+"\n";
                            textarea.scrollTop = textarea.scrollHeight;
                        }
                   });
                }
                if (cols.length == 7 && cols[0] != "Name") {
                    var year = parseInt(cols[2].split('-')[0]);
                    var now = new Date(cols[2].split(' ')[0]);
                    var start = new Date(year, 0, 0);
                    var diff =  now - start + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);;
                    var day = Math.floor(diff / (1000*60*60*24));
                    var params = {
                        TableName: "Shifts",
                        Item: {
                            "year": year,
                            "day" : day,
                            "Name": cols[0],
                            "Staff Type": cols[1],
                            "Clock-In-Date": cols[2].split(' ')[0],
                            "Clock-In": cols[2],
                            "Clock-Out": cols[3],
                            "Duration": Number(cols[4]),
                            "Hourly Rate": Number(cols[5].replace(/[^0-9.-]+/g,"")),
                            "Pay": Number(cols[6].replace(/[^0-9.-]+/g,"")),

                        }
                    };
                    docClient.put(params, function (err, data) {
                        if (err) {
                            console.log("Unable to add transaction: " + cols[11] + "\n");
                        } else {
                            document.getElementById('textarea').innerHTML += "Added: Shift for " + cols[0] + "\n";
                            textarea.scrollTop = textarea.scrollHeight;
                        }
                   });
                }

            });
    };
        r.readAsText(file);
    } else {
        alert("Could not read transaction data file");
    }
}

</script>
</head>

<body>
<table border = 1>
    <td>
        <table border = 1>
        <caption>Table Operations</caption>
        <td><input id="createTableButton" type="button" value="Create Table" onclick="createTables();" /></td><td><input id="deleteTableButton" type="button" value="Delete Table" onclick="deleteTables();" /></td><td><input id="listTablebutton" type="button" value="List Tables" onclick="listTables();" /></td>
        </table>
    </td>
    <td>
        <table border = 1>
            <caption>Scan</caption>
            <td><input id="scanData" type="button" value="Scan" onclick="scanTables();" /></td>
        </table>
    </td>
    <td>
        <table border = 1>
            <caption>Import Data</caption>
            <td><input type="file" id="fileinput" accept='.csv'/></td>
        </table>
    </td>
</table>

<br>
<!-- textarea readonly id= "textarea" style="width:400px; height:800px"></textarea -->
<div id= "textarea"></div>

<script>
    document.getElementById('fileinput').addEventListener('change', processFile, false);
</script>
</body>
</html>
